name: Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Commit all changes to repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "build: Update repository for ${GITHUB_REF_NAME}"
          git push origin HEAD:main

      - name: Generate release notes
        id: notes
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^[0-9]' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, skipping release notes."
            echo "BODY=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          SINCE=$(git log -1 --format=%aI "$PREV_TAG" | cut -dT -f1)

          PRS=$(gh pr list --state merged --search "merged:>=${SINCE}" --limit 200 \
            --json number,title,author \
            --jq '.[] | "- \(.title) #\(.number) by @\(.author.login)"')

          ISSUES=$(gh issue list --state closed --limit 200 \
            --json number,title,closedAt,stateReason \
            --jq "[.[] | select(.stateReason == \"COMPLETED\" and .closedAt >= \"${SINCE}\")] | .[] | \"- \(.title) #\(.number)\"")

          BODY=""
          if [ -n "$PRS" ]; then
            printf -v BODY '### Merged PRs\n\n%s' "$PRS"
          fi
          if [ -n "$ISSUES" ]; then
            if [ -n "$BODY" ]; then
              printf -v BODY '%s\n\n### Closed issues\n\n%s' "$BODY" "$ISSUES"
            else
              printf -v BODY '### Closed issues\n\n%s' "$ISSUES"
            fi
          fi

          {
            echo 'BODY<<EOF'
            echo "$BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release bundle
        run: |
          mkdir release
          cp main.js manifest.json styles.css release/
          cd release
          zip ../dynamic-views.zip main.js manifest.json styles.css

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.notes.outputs.BODY }}
          files: |
            main.js
            manifest.json
            styles.css
            dynamic-views.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
